<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ä¸èƒ½èªªçš„ç§˜å¯†ãŠ™ï¸ï½œä»Šå¤©åƒä»€éº¼ V2</title>
  <link rel="manifest" href="./manifest.webmanifest" />
<meta name="theme-color" content="#ffffff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="ä¸èƒ½èªªçš„ç§˜å¯†ãŠ™ï¸" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",Arial,sans-serif;
      background:#f5f6f8; margin:0; padding:18px;
    }
    .card{
      max-width:560px; margin:auto; background:#fff; padding:18px;
      border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
    h1{font-size:20px; text-align:center; margin:6px 0 14px;}
    .sub{font-size:12px; color:#6b7280; text-align:center; margin-bottom:8px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    label{display:block; margin-top:12px; font-size:14px;}
    input, select, button{
      width:100%; margin-top:8px; padding:10px; font-size:16px;
      border-radius:10px; border:1px solid #cfcfcf;
      box-sizing:border-box;
    }
    button{background:#2563eb; color:#fff; border:none; cursor:pointer;}
    button.secondary{background:#111827;}
    button.ghost{background:#fff; color:#111; border:1px solid #cfcfcf;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .hintrow{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .result{margin-top:14px; padding:12px; border-radius:12px; background:#f3f4f6;}
    .result .title{font-weight:700; font-size:18px;}
    .meta{font-size:13px; color:#374151; line-height:1.5;}
    .history ul{padding-left:18px; margin:8px 0 0;}
    a{color:#2563eb;}
  </style>
  <script>
  const GOOGLE_MAPS_API_KEY = "AIzaSyCTEKfqf7bG3_CnORAu1ubk7OTPYC3lD_s";
</script>

</head>
<body>
  <div class="card">
    <h1>ä¸èƒ½èªªçš„ç§˜å¯†ãŠ™ï¸ï½œä»Šå¤©åƒä»€éº¼ V2</h1>
    <div class="sub">å¿«é€Ÿæ±ºç­–ï½œå¯å¤šé¸æ¢ä»¶ï½œä¿ç•™è‡ªè¨‚ï½œæœƒè¨˜ä½ä½ è¿‘æœŸåƒéçš„</div>

    <div class="row">
      <div style="flex:1; min-width:160px;">
        <label>ç”¨é¤æ™‚æ®µ</label>
        <select id="mealTime">
          <option value="breakfast">æ—©é¤</option>
          <option value="lunch" selected>åˆé¤</option>
          <option value="dinner">æ™šé¤</option>
          <option value="any">ä¸åˆ†</option>
        </select>
      </div>
      <div style="flex:1; min-width:160px;">
    <div style="flex:1; min-width:160px;">
  <label>é¤å»³ç¯„åœï¼ˆå…¬å°ºï¼‰</label>
  <select id="radiusMeters">
    <option value="300">300mï¼ˆèµ°è·¯ 4 åˆ†é˜ï¼‰</option>
    <option value="500">500mï¼ˆèµ°è·¯ 7 åˆ†é˜ï¼‰</option>
    <option value="800">800mï¼ˆèµ°è·¯ 12 åˆ†é˜ï¼‰</option>
    <option value="1200" selected>1200mï¼ˆå¸¸ç”¨ï¼‰</option>
    <option value="2000">2000mï¼ˆé¨è»Š/é–‹è»Šï¼‰</option>
    <option value="3000">3000mï¼ˆæƒ³åƒå°±è¡ï¼‰</option>
  </select>
</div>

      </div>
    </div>

    <label>æ–™ç†ç³»ç³»ï¼ˆå¯å¤šé¸ï¼›ä¸é¸=ä¸é™ï¼‰</label>
    <select id="cuisine" multiple size="7">
      <option value="æ—¥å¼">æ—¥å¼æ–™ç†</option>
      <option value="ä¸­å¼">ä¸­å¼æ–™ç†</option>
      <option value="å°å¼">å°å¼æ–™ç†</option>
      <option value="æ¸¯å¼">æ¸¯å¼æ–™ç†</option>
      <option value="ç¾å¼">ç¾å¼æ–™ç†</option>
      <option value="ç¾©å¼">ç¾©å¼æ–™ç†</option>
      <option value="å—æ´‹">å—æ´‹æ–™ç†</option>
      <option value="æ³°å¼">æ³°å¼æ–™ç†</option>
      <option value="éŸ“å¼">éŸ“å¼æ–™ç†</option>
      <option value="è”¬é£Ÿ">ç´ é£Ÿ / è”¬é£Ÿ</option>
      <option value="æ··æ­">ç•°åœ‹æ··æ­</option>
    </select>

    <div class="hintrow">
      <button class="ghost" type="button" id="cAll">å…¨é¸</button>
      <button class="ghost" type="button" id="cClear">æ¸…é™¤</button>
      <button class="ghost" type="button" id="cSafe">å¸¸è¦‹</button>
    </div>

    <label>ç”¨é¤å½¢å¼ï¼ˆå¯å¤šé¸ï¼›ä¸é¸=ä¸é™ï¼‰</label>
    <select id="format" multiple size="8">
      <option value="ç«é‹">ç«é‹</option>
      <option value="ç°¡é¤">ç°¡é¤ / ä¾¿ç•¶</option>
      <option value="åˆèœ">åˆèœ</option>
      <option value="éºµé£Ÿ">éºµé£Ÿ / æ‹‰éºµ / ç²‰éºµ</option>
      <option value="é£¯é¡">é£¯é¡</option>
      <option value="ç‡’çƒ¤">ç‡’çƒ¤</option>
      <option value="ç†±ç‚’">ç†±ç‚’</option>
      <option value="æ—©åˆé¤">æ—©åˆé¤</option>
      <option value="è¼•é£Ÿ">è¼•é£Ÿ / å¥åº·é¤</option>
      <option value="å°åƒ">å°åƒ</option>
      <option value="åƒåˆ°é£½">åƒåˆ°é£½</option>
      <option value="å’–å•¡ç”œé»">å’–å•¡ / ç”œé»</option>
    </select>

    <div class="hintrow">
      <button class="ghost" type="button" id="fAll">å…¨é¸</button>
      <button class="ghost" type="button" id="fClear">æ¸…é™¤</button>
      <button class="ghost" type="button" id="fSolo">ä¸€äººå‹å–„</button>
      <button class="ghost" type="button" id="fGroup">å¤šäººèšé¤</button>
    </div>

    <label>ä¸åƒé—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¯ç©ºç™½ï¼‰</label>
    <input id="ban" placeholder="ä¾‹å¦‚ï¼šå’–å“©,è¾£,å…§è‡Ÿ" />

    <label>è‡ªè¨‚è£œå……ï¼ˆé¸å¡«ï¼Œé€—è™Ÿåˆ†éš”ï¼‰</label>
    <input id="customFood" placeholder="ä¾‹å¦‚ï¼šç‰›è‚‰éºµ,é…¸èœç™½è‚‰é‹,æ—¥å¼å®šé£Ÿ" />

    <div class="grid2">
      <button type="button" id="btnDecide">å¹«æˆ‘æ±ºå®š</button>
      <button type="button" class="secondary" id="btnThree">ä¸‰é¸ä¸€ï¼ˆé™ä½è¸©é›·ï¼‰</button>
    </div>

    <div class="result" id="resultBox" style="display:none;">
      <div class="title" id="resultTitle"></div>
      <div class="meta" id="resultMeta"></div>

      <div class="grid2">
        <button class="ghost" type="button" id="btnMaps">Google Maps æ‰¾é™„è¿‘</button>
        <button class="ghost" type="button" id="btnCopy">ä¸€éµè¤‡è£½ï¼ˆè²¼åˆ° LINEï¼‰</button>
      </div>
    </div>

    <div class="history">
      <label>æœ€è¿‘æ±ºç­–ç´€éŒ„ï¼ˆæœ¬æ©Ÿï¼‰</label>
      <ul id="historyList"></ul>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "eat_decider_history_v2";

    const FOOD_DB = [
      {name:"æ—¥å¼æ‹‰éºµ",c:"æ—¥å¼",f:"éºµé£Ÿ"},
      {name:"æ—¥å¼å®šé£Ÿ",c:"æ—¥å¼",f:"ç°¡é¤"},
      {name:"å£½å¸",c:"æ—¥å¼",f:"åˆèœ"},
      {name:"ç‰›è‚‰éºµ",c:"ä¸­å¼",f:"éºµé£Ÿ"},
      {name:"æ°´é¤ƒ / é‹è²¼",c:"ä¸­å¼",f:"å°åƒ"},
      {name:"æ»·è‚‰é£¯",c:"å°å¼",f:"é£¯é¡"},
      {name:"é¹½é…¥é›",c:"å°å¼",f:"å°åƒ"},
      {name:"æ¸¯å¼é»å¿ƒ",c:"æ¸¯å¼",f:"åˆèœ"},
      {name:"ç¾å¼æ¼¢å ¡",c:"ç¾å¼",f:"ç°¡é¤"},
      {name:"ç¾©å¤§åˆ©éºµ",c:"ç¾©å¼",f:"ç°¡é¤"},
      {name:"å—æ´‹æ–™ç†",c:"å—æ´‹",f:"åˆèœ"},
      {name:"æ³°å¼æ–™ç†",c:"æ³°å¼",f:"åˆèœ"},
      {name:"éŸ“å¼æ–™ç†",c:"éŸ“å¼",f:"åˆèœ"},
      {name:"ç«é‹",c:"æ··æ­",f:"ç«é‹"},
      {name:"ç‡’çƒ¤",c:"æ··æ­",f:"ç‡’çƒ¤"},
      {name:"ç†±ç‚’",c:"å°å¼",f:"ç†±ç‚’"},
      {name:"æ—©åˆé¤",c:"æ··æ­",f:"æ—©åˆé¤"},
      {name:"å¥åº·é¤ç›’",c:"æ··æ­",f:"è¼•é£Ÿ"},
      {name:"åƒåˆ°é£½",c:"æ··æ­",f:"åƒåˆ°é£½"},
      {name:"å’–å•¡ç”œé»",c:"æ··æ­",f:"å’–å•¡ç”œé»"}
    ];

    // ä½ åå¥½ï¼šå–œæ­¡æ—¥å¼ã€ä¸å–œæ­¡å’–å“©/éŸ“/æ³°/è¶Šï¼ˆå¯è‡ªè¡Œåˆªæ‰ï¼‰
    const PREFER = new Set(["æ—¥å¼"]);
    const DISLIKE = new Set(["éŸ“å¼","æ³°å¼"]);

    function $(id){ return document.getElementById(id); }
    function getSelectedValues(id){
      return [...$(id).selectedOptions].map(o=>o.value);
    }
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }catch{ return []; }
    }
    function saveHistory(h){ localStorage.setItem(STORAGE_KEY, JSON.stringify(h.slice(0,10))); }
    function renderHistory(){
      const ul = $("historyList"); ul.innerHTML="";
      loadHistory().forEach(x=>{
        const li=document.createElement("li");
        li.textContent=`${x.name}ï¼ˆ${x.time}ï¼‰`;
        ul.appendChild(li);
      });
    }
    function setMulti(id, arr){
      [...$(id).options].forEach(o=>o.selected=arr.includes(o.value));
    }

    function pickCandidates(triple){
      const cuisines = getSelectedValues("cuisine");
      const formats  = getSelectedValues("format");
      const banRaw = $("ban").value.trim();
      const ban = banRaw ? banRaw.split(",").map(s=>s.trim()).filter(Boolean) : [];
      const customRaw = $("customFood").value.trim();
      const custom = customRaw ? customRaw.split(",").map(s=>s.trim()).filter(Boolean) : [];

      let pool = FOOD_DB.filter(x=>{
        const cOK = cuisines.length===0 || cuisines.includes(x.c) || x.c==="æ··æ­";
        const fOK = formats.length===0 || formats.includes(x.f);
        const banOK = ban.length===0 || !ban.some(b=>x.name.includes(b));
        const dislikeOK = !DISLIKE.has(x.c);
        return cOK && fOK && banOK && dislikeOK;
      });

      // åŠ å…¥è‡ªè¨‚é¸é …ï¼ˆè¦–ç‚ºæ··æ­ï¼‰
      custom.forEach(name=>{
        if(name) pool.push({name, c:"æ··æ­", f:"è‡ªè¨‚"});
      });

      // ä¿åº•ï¼šæ¢ä»¶å¤ªåš´æ ¼å°±æ”¾å¯¬ï¼ˆé¿å…æŒ‰äº†æ²’çµæœï¼‰
      if(pool.length===0){
        pool = FOOD_DB.slice();
      }

      // ç°¡å–®åå¥½åŠ æ¬Šï¼ˆä¸æ”¹ UIï¼Œåªæé«˜æŠ½ä¸­æ©Ÿç‡ï¼‰
      const weighted = [];
      pool.forEach(x=>{
        const w = PREFER.has(x.c) ? 3 : 1;
        for(let i=0;i<w;i++) weighted.push(x);
      });

      if(!triple){
        return [ weighted[Math.floor(Math.random()*weighted.length)] ];
      }

      // ä¸‰é¸ä¸€ï¼šæŠ½ä¸é‡è¤‡
      const out = [];
      const seen = new Set();
      let guard = 0;
      while(out.length<3 && guard<100){
        const x = weighted[Math.floor(Math.random()*weighted.length)];
        if(!seen.has(x.name)){ seen.add(x.name); out.push(x); }
        guard++;
      }
      return out;
    }

    function showResult(list){
      $("resultBox").style.display="block";
      if(list.length===1){
        $("resultTitle").textContent = "çµè«–ï¼š" + list[0].name;
        $("resultMeta").innerHTML = "";
      }else{
        $("resultTitle").textContent = "ä¸‰é¸ä¸€ï¼ˆä½ é¸ä¸€å€‹ï¼‰";
        $("resultMeta").innerHTML = list.map((x,i)=>`${i+1}. ${x.name}`).join("<br>");
      }

      // å¯«å…¥ç´€éŒ„ï¼ˆåªè¨˜ç¬¬ä¸€å€‹ï¼‰
      const h = loadHistory();
      h.unshift({name:list[0].name, time:new Date().toLocaleString()});
      saveHistory(h);
      renderHistory();

      // Maps é—œéµå­—
      window.__lastKeyword = list[0].name + " é™„è¿‘";
    }

    function decide(triple){
      const list = pickCandidates(triple);
      showResult(list);
    }

    function openMaps(){
      const q = encodeURIComponent(window.__lastKeyword || "é¤å»³ é™„è¿‘");
      window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
    }

    async function copyResult(){
      const text = `${$("resultTitle").textContent}\n${$("resultMeta").innerText || ""}`.trim();
      try{
        await navigator.clipboard.writeText(text);
        alert("å·²è¤‡è£½ï¼Œå¯è²¼åˆ° LINE");
      }catch{
        alert("è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰ï¼Œå¯æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚");
      }
    }

    // ç¶å®šæŒ‰éˆ•ï¼ˆé¿å… iOS/æŸäº›ç’°å¢ƒ onclick å¤±æ•ˆï¼‰
    $("btnDecide").addEventListener("click", ()=>decide(false));
    $("btnThree").addEventListener("click", ()=>decide(true));
    $("btnMaps").addEventListener("click", openMaps);
    $("btnCopy").addEventListener("click", copyResult);

    // å¿«é€Ÿé¸å–
    $("cAll").addEventListener("click", ()=>setMulti("cuisine",
      ["æ—¥å¼","ä¸­å¼","å°å¼","æ¸¯å¼","ç¾å¼","ç¾©å¼","å—æ´‹","æ³°å¼","éŸ“å¼","è”¬é£Ÿ","æ··æ­"]
    ));
    $("cClear").addEventListener("click", ()=>setMulti("cuisine", []));
    $("cSafe").addEventListener("click", ()=>setMulti("cuisine", ["æ—¥å¼","å°å¼","ä¸­å¼","æ··æ­"]));

    $("fAll").addEventListener("click", ()=>setMulti("format",
      ["ç«é‹","ç°¡é¤","åˆèœ","éºµé£Ÿ","é£¯é¡","ç‡’çƒ¤","ç†±ç‚’","æ—©åˆé¤","è¼•é£Ÿ","å°åƒ","åƒåˆ°é£½","å’–å•¡ç”œé»"]
    ));
    $("fClear").addEventListener("click", ()=>setMulti("format", []));
    $("fSolo").addEventListener("click", ()=>setMulti("format", ["ç°¡é¤","éºµé£Ÿ","é£¯é¡","å°åƒ","è¼•é£Ÿ","å’–å•¡ç”œé»"]));
    $("fGroup").addEventListener("click", ()=>setMulti("format", ["ç«é‹","åˆèœ","ç‡’çƒ¤","ç†±ç‚’","åƒåˆ°é£½"]));

    renderHistory();
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
</script>

  <!-- ====== é™„è¿‘é¤å»³æ¨è–¦ï¼ˆPlacesï¼‰UI ====== -->
<div id="placesBox" style="display:none; margin-top:16px; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;">
  <div style="font-weight:800; font-size:18px;">é™„è¿‘é¤å»³æ¨è–¦</div>
  <div id="placesMeta" style="margin-top:6px; color:#6b7280; font-size:13px;"></div>
  <div id="placesList" style="margin-top:10px; display:grid; gap:10px;"></div>

  <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
    <button type="button" id="btnShareLine">åˆ†äº«çµ¦ LINE</button>
    <button type="button" id="btnRefreshPlaces">é‡æ–°æ¨è–¦</button>
  </div>
</div>

<div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
  <button type="button" id="btnPlaces">ğŸ“ æ¨è–¦é™„è¿‘é¤å»³</button>
  <button type="button" id="btnOpenMapsAll">åœ¨ Google Maps çœ‹æ›´å¤š</button>
</div>
<!-- ====== /é™„è¿‘é¤å»³æ¨è–¦ï¼ˆPlacesï¼‰UI ====== -->

<script>
  function loadGoogleMaps(cb){
    if (window.google && window.google.maps && window.google.maps.places) return cb();
    const s = document.createElement("script");
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW&region=TW`;
    s.async = true;
    s.defer = true;
    s.onload = cb;
    document.head.appendChild(s);
  }
// ====== Placesï¼šé™„è¿‘é¤å»³æ¨è–¦ï¼ˆé¡¯ç¤ºåº—å/è©•åˆ†/åœ°å€ + é–‹åœ°åœ– + åˆ†äº« LINEï¼‰======
let __lastShareText = "";
let __lastMoreUrl = "";

// å¦‚æœä½ åŸæœ¬æ²’æœ‰ escapeHtmlï¼Œè£œä¸Šï¼ˆé¿å…ç‰¹æ®Šå­—å…ƒå£æ‰ï¼‰
if (typeof escapeHtml !== "function") {
  window.escapeHtml = function (s) {
    return String(s).replace(/[&<>"']/g, (m) =>
      ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m])
    );
  };
}

function buildPlacesQuery(){
  const cuisines = getSelectedValues("cuisine"); // æ–™ç†ç³»ç³»ï¼ˆä½ ä¸Šé¢é¸çš„ï¼‰
  const formats  = getSelectedValues("format");  // ç”¨é¤å½¢å¼ï¼ˆä½ ä¸Šé¢é¸çš„ï¼‰

  // æŠŠã€Œå½¢å¼ã€è½‰æˆ Google æ¯”è¼ƒåƒå¾—æ‡‚çš„æœå°‹å­—
  const formatMap = {
    "ç«é‹": "ç«é‹",
    "ç‡’çƒ¤": "ç‡’è‚‰ ç‡’çƒ¤",
    "ç†±ç‚’": "ç†±ç‚’",
    "éºµé£Ÿ": "æ‹‰éºµ éºµé£Ÿ",
    "é£¯é¡": "ä¸¼é£¯ ä¾¿ç•¶ é£¯",
    "ç°¡é¤": "ç°¡é¤ å®šé£Ÿ ä¾¿ç•¶",
    "åˆèœ": "åˆèœ æ¡Œèœ",
    "æ—©åˆé¤": "æ—©åˆé¤",
    "è¼•é£Ÿ": "è¼•é£Ÿ å¥åº·é¤",
    "å°åƒ": "å°åƒ",
    "åƒåˆ°é£½": "åƒåˆ°é£½",
    "å’–å•¡ç”œé»": "å’–å•¡ ç”œé»"
  };

  const parts = [];

  if (cuisines.length) parts.push(cuisines.join(" "));
  if (formats.length)  parts.push(formats.map(f => formatMap[f] || f).join(" "));

  // ä¿åº•ï¼šæ°¸é åŠ é¤å»³
  parts.push("é¤å»³");

  return parts.join(" ").trim();
}


function renderPlaces(list, keyword, lat, lng){
  const box  = document.getElementById("placesBox");
  const meta = document.getElementById("placesMeta");
  const wrap = document.getElementById("placesList");

  box.style.display = "block";
  const r = parseInt(document.getElementById("radiusMeters")?.value || "1200", 10);
meta.textContent = `é—œéµå­—ï¼š${keyword}ï½œç¯„åœï¼š${r}m`;


  wrap.innerHTML = "";
  list.forEach((p, idx) => {
    const rating = (p.rating ?? "â€”");
    const total  = (p.user_ratings_total ?? "â€”");
    const addr   = (p.vicinity ?? "");
    const url    = mapsUrlForPlace(p);

    const card = document.createElement("div");
    card.style.cssText = "border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;";
    card.innerHTML = `
      <div style="font-weight:800;font-size:16px;">${idx+1}. ${escapeHtml(p.name || "é¤å»³")}</div>
      <div style="margin-top:6px;font-size:13px;color:#374151;line-height:1.5;">
        â­ ${rating}ï¼ˆ${total}ï¼‰<br>
        <span style="color:#6b7280;">${escapeHtml(addr)}</span>
      </div>
      <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <button type="button" class="ghost">é–‹å•Ÿåœ°åœ–</button>
        <button type="button" class="ghost">åˆ†äº« LINE</button>
      </div>
    `;

    const [btnMap, btnShare] = card.querySelectorAll("button");

    btnMap.addEventListener("click", () => {
      __lastShareText = `æ¨è–¦é¤å»³ï¼š${p.name}\n${url}`;
      window.open(url, "_blank");
    });

    btnShare.addEventListener("click", async () => {
      const text = `æ¨è–¦é¤å»³ï¼š${p.name}\n${url}`;
      __lastShareText = text;

      // iPhone Safariï¼šæœƒè·³ç³»çµ±åˆ†äº«é¢æ¿ï¼ˆå¯é¸ LINEï¼‰
      if (navigator.share) {
        try { await navigator.share({ title: "é™„è¿‘é¤å»³æ¨è–¦", text, url }); return; } catch(e) {}
      }
      // ä¸æ”¯æ´å°±è¤‡è£½
      try { await navigator.clipboard.writeText(text); alert("å·²è¤‡è£½ï¼Œè²¼åˆ° LINE å³å¯"); }
      catch(e){ alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"); }
    });

    wrap.appendChild(card);
  });

  __lastMoreUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword + " near me")}&center=${lat},${lng}`;
  __lastShareText = `é™„è¿‘é¤å»³æ¨è–¦ï¼ˆ${keyword}ï¼‰\n${__lastMoreUrl}`;
}

function recommendPlaces(){
  const keyword = buildPlacesQuery();

  if (!navigator.geolocation) {
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      loadGoogleMaps(() => {
        const service = new google.maps.places.PlacesService(document.getElementById("placesServiceAnchor"));


        service.nearbySearch(
          {
            location: { lat, lng },
            radius: parseInt(document.getElementById("radiusMeters")?.value || "1200", 10),

            type: "restaurant",
            keyword: keyword
          },
      (results, status) => {
  const wrap = document.getElementById("placesList");
  const meta = document.getElementById("placesMeta");
  const r = parseInt(document.getElementById("radiusMeters")?.value || "1200", 10);

  meta.textContent = `é—œéµå­—ï¼š${keyword}ï½œç¯„åœï¼š${r}mï½œç‹€æ…‹ï¼š${status}ï½œç­†æ•¸ï¼š${results ? results.length : 0}`;

  if (status !== google.maps.places.PlacesServiceStatus.OK || !results || results.length === 0) {
    wrap.innerHTML = `<div style="color:#6b7280;font-size:13px;">æ‰¾ä¸åˆ°çµæœï¼ˆå¯æŠŠç¯„åœèª¿å¤§æˆ–é—œéµå­—é¸å°‘ä¸€é»ï¼‰</div>`;
    return;
  }

  renderPlaces(results.slice(0, 5), keyword, lat, lng);
}
);
          }
        );
      });
    },
    () => alert("å®šä½å¤±æ•—æˆ–æœªå…è¨±å®šä½ï¼ˆiPhoneï¼šè¨­å®š > Safari > å®šä½ å…è¨±ï¼‰"),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
  );
}

// ç¶å®š UI æŒ‰éˆ•
document.getElementById("btnPlaces")?.addEventListener("click", recommendPlaces);
document.getElementById("btnRefreshPlaces")?.addEventListener("click", recommendPlaces);
document.getElementById("btnOpenMapsAll")?.addEventListener("click", () => {
  if (!__lastMoreUrl) return alert("è«‹å…ˆæŒ‰ã€Œæ¨è–¦é™„è¿‘é¤å»³ã€");
  window.open(__lastMoreUrl, "_blank");
});
document.getElementById("btnShareLine")?.addEventListener("click", async () => {
  if (!__lastShareText) return alert("è«‹å…ˆæŒ‰ã€Œæ¨è–¦é™„è¿‘é¤å»³ã€");
  if (navigator.share) {
    try { await navigator.share({ title:"é™„è¿‘é¤å»³æ¨è–¦", text: __lastShareText, url: __lastMoreUrl }); return; } catch(e) {}
  }
  try { await navigator.clipboard.writeText(__lastShareText); alert("å·²è¤‡è£½ï¼Œè²¼åˆ° LINE å³å¯"); }
  catch(e){ alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"); }
});

</script>
<!-- Google Places Service anchor (must be in DOM for iOS Safari) -->
<div id="placesServiceAnchor" style="display:none;"></div>

  
</body>
</html>





