<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ä¸èƒ½èªªçš„ç§˜å¯†ãŠ™ï¸ï½œä»Šå¤©åƒä»€éº¼ V2</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ä¸èƒ½èªªçš„ç§˜å¯†ãŠ™ï¸" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- 1) æŠŠä½ çš„ Google API Key è²¼åœ¨é€™è£¡ -->
  <script>
    const GOOGLE_MAPS_API_KEY = "PASTE_YOUR_API_KEY_HERE";
  </script>

  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial; background:#f7f7f8; color:var(--t); }
    .wrap{ max-width:720px; margin:0 auto; padding:16px; }
    .card{ background:#fff; border:1px solid var(--b); border-radius:14px; padding:14px; }
    h1{ font-size:20px; margin:0 0 10px; }
    .sub{ color:var(--m); font-size:13px; margin-bottom:12px; line-height:1.4; }
    .grid{ display:grid; gap:10px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; }
    .group{ border:1px solid var(--b); border-radius:12px; padding:10px; }
    .group-title{ font-weight:800; font-size:14px; margin-bottom:8px; }
    label.opt{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--b); border-radius:999px; font-size:13px; cursor:pointer; user-select:none; }
    input[type="checkbox"]{ transform:translateY(1px); }
    select{ width:100%; padding:10px; border:1px solid var(--b); border-radius:10px; background:#fff; font-size:14px; }
    button{ padding:12px 12px; border-radius:12px; border:1px solid var(--b); background:#111827; color:#fff; font-weight:800; font-size:14px; cursor:pointer; }
    button.secondary{ background:#fff; color:#111827; }
    button.ghost{ background:#fff; color:#111827; }
    button:active{ transform:scale(0.99); }
    .result{ margin-top:12px; }
    .title{ font-weight:900; font-size:18px; }
    .meta{ margin-top:6px; color:var(--m); font-size:13px; line-height:1.4; }
    .small{ color:var(--m); font-size:12px; }
    .list{ margin-top:10px; display:grid; gap:10px; }
    .place{ border:1px solid var(--b); border-radius:12px; padding:10px; background:#fff; }
    .place-name{ font-weight:900; font-size:16px; }
    .place-meta{ margin-top:6px; font-size:13px; color:#374151; line-height:1.45; }
    .dbg{ margin-top:10px; padding:10px; border:1px dashed #cbd5e1; border-radius:12px; background:#f8fafc; color:#334155; font-size:12px; }
    .dbg b{ display:block; margin-bottom:6px; }
    .dbg pre{ margin:0; white-space:pre-wrap; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>ä¸èƒ½èªªçš„ç§˜å¯†ãŠ™ï¸ï½œä»Šå¤©åƒä»€éº¼ V2</h1>
      <div class="sub">
        é¸å¥½æ¢ä»¶ â†’ æ¨è–¦é™„è¿‘é¤å»³ï¼ˆé¡¯ç¤ºåº—åï¼‰ â†’ ä¸€éµé–‹ Google Maps â†’ å¯åˆ†äº« LINE
      </div>

      <div class="grid">
        <div class="group">
          <div class="group-title">æ–™ç†é¡å‹ï¼ˆå¯å¤šé¸ï¼‰</div>
          <div class="row" id="cuisineGroup">
            <label class="opt"><input type="checkbox" name="cuisine" value="æ—¥å¼æ–™ç†">æ—¥å¼æ–™ç†</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="å°å¼æ–™ç†">å°å¼æ–™ç†</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="ä¸­å¼æ–™ç†">ä¸­å¼æ–™ç†</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="ç¾©å¼æ–™ç†">ç¾©å¼æ–™ç†</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="ç¾å¼æ–™ç†">ç¾å¼æ–™ç†</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="æ¸¯å¼æ–™ç†">æ¸¯å¼æ–™ç†</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="å®¢å®¶æ–™ç†">å®¢å®¶æ–™ç†</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="ç´ é£Ÿ">ç´ é£Ÿ</label>
            <label class="opt"><input type="checkbox" name="cuisine" value="è‡ªè¨‚" id="cuisineCustomToggle">è‡ªè¨‚</label>
          </div>

          <div id="cuisineCustomBox" style="display:none;margin-top:10px;">
            <div class="small">è‡ªè¨‚æ–™ç†é—œéµå­—ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå·èœ éº»è¾£ï¼‰</div>
            <input id="cuisineCustomText" placeholder="ä¾‹å¦‚ï¼šå·èœ éº»è¾£" style="width:100%;margin-top:6px;padding:10px;border:1px solid var(--b);border-radius:10px;font-size:14px;" />
          </div>
        </div>

        <div class="group">
          <div class="group-title">ç”¨é¤å½¢å¼ï¼ˆå¯å¤šé¸ï¼‰</div>
          <div class="row" id="formatGroup">
            <label class="opt"><input type="checkbox" name="format" value="ç«é‹">ç«é‹</label>
            <label class="opt"><input type="checkbox" name="format" value="ç‡’çƒ¤">ç‡’çƒ¤</label>
            <label class="opt"><input type="checkbox" name="format" value="ç†±ç‚’">ç†±ç‚’</label>
            <label class="opt"><input type="checkbox" name="format" value="åˆèœ">åˆèœ</label>
            <label class="opt"><input type="checkbox" name="format" value="ç°¡é¤">ç°¡é¤</label>
            <label class="opt"><input type="checkbox" name="format" value="å°åƒ">å°åƒ</label>
            <label class="opt"><input type="checkbox" name="format" value="æ—©åˆé¤">æ—©åˆé¤</label>
            <label class="opt"><input type="checkbox" name="format" value="åƒåˆ°é£½">åƒåˆ°é£½</label>
            <label class="opt"><input type="checkbox" name="format" value="å’–å•¡ç”œé»">å’–å•¡ç”œé»</label>
            <label class="opt"><input type="checkbox" name="format" value="è‡ªè¨‚" id="formatCustomToggle">è‡ªè¨‚</label>
          </div>

          <div id="formatCustomBox" style="display:none;margin-top:10px;">
            <div class="small">è‡ªè¨‚å½¢å¼é—œéµå­—ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå±…é…’å±‹ ä¸²ç‡’ï¼‰</div>
            <input id="formatCustomText" placeholder="ä¾‹å¦‚ï¼šå±…é…’å±‹ ä¸²ç‡’" style="width:100%;margin-top:6px;padding:10px;border:1px solid var(--b);border-radius:10px;font-size:14px;" />
          </div>
        </div>

        <div class="grid2">
          <div>
            <div class="small" style="margin-bottom:6px;">é¤å»³ç¯„åœï¼ˆå…¬å°ºï¼‰</div>
            <select id="radiusMeters">
              <option value="300">300mï¼ˆèµ°è·¯ 4 åˆ†é˜ï¼‰</option>
              <option value="500">500mï¼ˆèµ°è·¯ 7 åˆ†é˜ï¼‰</option>
              <option value="800">800mï¼ˆèµ°è·¯ 12 åˆ†é˜ï¼‰</option>
              <option value="1200" selected>1200mï¼ˆå¸¸ç”¨ï¼‰</option>
              <option value="2000">2000mï¼ˆé¨è»Š/é–‹è»Šï¼‰</option>
              <option value="3000">3000mï¼ˆæƒ³åƒå°±è¡ï¼‰</option>
            </select>
          </div>
          <div>
            <div class="small" style="margin-bottom:6px;">é¡¯ç¤ºç­†æ•¸</div>
            <select id="limitCount">
              <option value="3">3 é–“</option>
              <option value="5" selected>5 é–“</option>
              <option value="8">8 é–“</option>
            </select>
          </div>
        </div>

        <div class="grid2">
          <button type="button" id="btnPlaces">ğŸ“ æ¨è–¦é™„è¿‘é¤å»³</button>
          <button type="button" class="secondary" id="btnOpenMapsAll">åœ¨ Google Maps çœ‹æ›´å¤š</button>
        </div>

        <div class="result" id="placesBox" style="display:none;">
          <div class="title">é™„è¿‘é¤å»³æ¨è–¦</div>
          <div class="meta" id="placesMeta"></div>
          <div class="list" id="placesList"></div>

          <div class="grid2" style="margin-top:10px;">
            <button class="ghost" type="button" id="btnShareLine">åˆ†äº«çµ¦ LINE</button>
            <button class="ghost" type="button" id="btnRefreshPlaces">é‡æ–°æ¨è–¦</button>
          </div>

          <div class="dbg" id="dbgBox" style="display:none;">
            <b>Debug</b>
            <pre id="dbgText"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Places Service anchor (must be in DOM for iOS Safari) -->
  <div id="placesServiceAnchor" style="display:none;"></div>

  <script>
    // ---------- helpers ----------
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#039;" }[m]));
    }

    function getSelectedValues(name){
      return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
        .map(el => el.value)
        .filter(v => v !== "è‡ªè¨‚");
    }

    function dbg(msg){
      const box = document.getElementById("dbgBox");
      const el = document.getElementById("dbgText");
      if (!box || !el) return;
      box.style.display = "block";
      const t = new Date().toLocaleTimeString();
      el.textContent = `[${t}] ${msg}\n` + el.textContent;
    }

    // ---------- custom keyword toggles ----------
    const cuisineCustomToggle = document.getElementById("cuisineCustomToggle");
    const cuisineCustomBox = document.getElementById("cuisineCustomBox");
    const formatCustomToggle = document.getElementById("formatCustomToggle");
    const formatCustomBox = document.getElementById("formatCustomBox");

    cuisineCustomToggle?.addEventListener("change", () => {
      cuisineCustomBox.style.display = cuisineCustomToggle.checked ? "block" : "none";
    });
    formatCustomToggle?.addEventListener("change", () => {
      formatCustomBox.style.display = formatCustomToggle.checked ? "block" : "none";
    });

    // ---------- build query (based on your selections) ----------
    function buildPlacesQuery(){
      const cuisines = getSelectedValues("cuisine");
      const formats  = getSelectedValues("format");

      const cuisineCustom = (document.getElementById("cuisineCustomText")?.value || "").trim();
      const formatCustom  = (document.getElementById("formatCustomText")?.value || "").trim();

      // ç”¨é¤å½¢å¼ â†’ Google æ¯”è¼ƒåƒå¾—æ‡‚çš„æœå°‹è©
      const formatMap = {
        "ç«é‹": "ç«é‹",
        "ç‡’çƒ¤": "ç‡’è‚‰ ç‡’çƒ¤",
        "ç†±ç‚’": "ç†±ç‚’",
        "åˆèœ": "åˆèœ æ¡Œèœ",
        "ç°¡é¤": "ç°¡é¤ å®šé£Ÿ ä¾¿ç•¶",
        "å°åƒ": "å°åƒ",
        "æ—©åˆé¤": "æ—©åˆé¤",
        "åƒåˆ°é£½": "åƒåˆ°é£½",
        "å’–å•¡ç”œé»": "å’–å•¡ ç”œé»"
      };

      const parts = [];
      if (cuisines.length) parts.push(cuisines.join(" "));
      if (formats.length)  parts.push(formats.map(f => formatMap[f] || f).join(" "));
      if (cuisineCustom)   parts.push(cuisineCustom);
      if (formatCustom)    parts.push(formatCustom);

      parts.push("é¤å»³");
      return parts.join(" ").trim();
    }

    // ---------- load google maps js (places) ----------
    function loadGoogleMaps(cb){
      if (window.google && window.google.maps && window.google.maps.places) return cb();
      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW&region=TW`;
      s.async = true;
      s.defer = true;
      s.onload = cb;
      s.onerror = () => alert("Google Maps SDK è¼‰å…¥å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ API Key / é™åˆ¶ / æ˜¯å¦å•Ÿç”¨ Maps JavaScript APIï¼‰");
      document.head.appendChild(s);
    }

    // ---------- UI render ----------
    let __lastShareText = "";
    let __lastMoreUrl = "";

    function mapsUrlForPlace(p){
      const name = encodeURIComponent(p.name || "é¤å»³");
      // place_id æœ‰æ™‚æ›´æº–
      return `https://www.google.com/maps/search/?api=1&query=${name}&query_place_id=${p.place_id || ""}`;
    }

    function renderPlaces(list, keyword, radius){
      const box  = document.getElementById("placesBox");
      const meta = document.getElementById("placesMeta");
      const wrap = document.getElementById("placesList");

      box.style.display = "block";
      meta.textContent = `é—œéµå­—ï¼š${keyword}ï½œç¯„åœï¼š${radius}m`;

      wrap.innerHTML = "";
      list.forEach((p, idx) => {
        const rating = (p.rating ?? "â€”");
        const total  = (p.user_ratings_total ?? "â€”");
        const addr   = (p.vicinity ?? "");
        const url    = mapsUrlForPlace(p);

        const card = document.createElement("div");
        card.className = "place";
        card.innerHTML = `
          <div class="place-name">${idx + 1}. ${escapeHtml(p.name || "é¤å»³")}</div>
          <div class="place-meta">
            â­ ${rating}ï¼ˆ${total}ï¼‰<br/>
            <span style="color:#6b7280;">${escapeHtml(addr)}</span>
          </div>
          <div class="grid2" style="margin-top:8px;">
            <button type="button" class="ghost">é–‹å•Ÿåœ°åœ–</button>
            <button type="button" class="ghost">åˆ†äº« LINE</button>
          </div>
        `;

        const [btnMap, btnShare] = card.querySelectorAll("button");

        btnMap.addEventListener("click", () => {
          __lastShareText = `æ¨è–¦é¤å»³ï¼š${p.name}\n${url}`;
          window.open(url, "_blank");
        });

        btnShare.addEventListener("click", async () => {
          const text = `æ¨è–¦é¤å»³ï¼š${p.name}\n${url}`;
          __lastShareText = text;

          if (navigator.share) {
            try { await navigator.share({ title: "é™„è¿‘é¤å»³æ¨è–¦", text, url }); return; } catch(e) {}
          }
          try { await navigator.clipboard.writeText(text); alert("å·²è¤‡è£½ï¼Œè²¼åˆ° LINE å³å¯"); }
          catch(e){ alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"); }
        });

        wrap.appendChild(card);
      });
    }

    // ---------- main: recommend places ----------
    function recommendPlaces(){
      if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY.includes("PASTE_")) {
        alert("ä½ é‚„æ²’åœ¨ index.html è£¡è²¼ä¸Š GOOGLE_MAPS_API_KEY");
        return;
      }

      const keyword = buildPlacesQuery();
      const radius = parseInt(document.getElementById("radiusMeters")?.value || "1200", 10);
      const limit  = parseInt(document.getElementById("limitCount")?.value || "5", 10);

      dbg(`start keyword="${keyword}", radius=${radius}, limit=${limit}`);

      if (!navigator.geolocation) {
        alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
        return;
      }

      dbg("request geolocation...");
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          dbg(`geolocation OK lat=${lat}, lng=${lng}`);

          loadGoogleMaps(() => {
            dbg("Google Maps SDK loaded");

            const anchor = document.getElementById("placesServiceAnchor");
            const service = new google.maps.places.PlacesService(anchor);

            dbg(`nearbySearch...`);
            service.nearbySearch(
              {
                location: { lat, lng },
                radius: radius,
                // åªç”¨ keywordï¼ˆä¿ç•™ radius æ•ˆæœæ›´æ˜é¡¯ï¼‰
                keyword: keyword
              },
              (results, status) => {
                dbg(`callback status=${status}, count=${results ? results.length : 0}`);

                const box  = document.getElementById("placesBox");
                const meta = document.getElementById("placesMeta");
                const wrap = document.getElementById("placesList");
                box.style.display = "block";
                meta.textContent = `é—œéµå­—ï¼š${keyword}ï½œç¯„åœï¼š${radius}mï½œç‹€æ…‹ï¼š${status}ï½œç­†æ•¸ï¼š${results ? results.length : 0}`;

                if (status !== google.maps.places.PlacesServiceStatus.OK || !results || results.length === 0) {
                  wrap.innerHTML = `<div class="small">æ‰¾ä¸åˆ°çµæœï¼ˆå¯æŠŠç¯„åœèª¿å¤§åˆ° 2000m/3000mï¼Œæˆ–æŠŠé¸é …é¸å°‘ä¸€é»ï¼‰</div>`;
                  __lastMoreUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword + " near me")}&center=${lat},${lng}`;
                  __lastShareText = `é™„è¿‘é¤å»³æ¨è–¦ï¼ˆ${keyword}ï¼‰\n${__lastMoreUrl}`;
                  return;
                }

                const sliced = results.slice(0, limit);
                renderPlaces(sliced, keyword, radius);

                __lastMoreUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword + " near me")}&center=${lat},${lng}`;
                __lastShareText = `é™„è¿‘é¤å»³æ¨è–¦ï¼ˆ${keyword}ï¼‰\n${__lastMoreUrl}`;
              }
            );
          });
        },
        () => alert("å®šä½å¤±æ•—æˆ–æœªå…è¨±å®šä½ï¼ˆiPhoneï¼šè¨­å®š > Safari > å®šä½ å…è¨±ï¼‰"),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
      );
    }

    // ---------- top buttons ----------
    document.getElementById("btnPlaces")?.addEventListener("click", recommendPlaces);
    document.getElementById("btnRefreshPlaces")?.addEventListener("click", recommendPlaces);

    document.getElementById("btnOpenMapsAll")?.addEventListener("click", () => {
      if (!__lastMoreUrl) return alert("è«‹å…ˆæŒ‰ã€ŒğŸ“ æ¨è–¦é™„è¿‘é¤å»³ã€");
      window.open(__lastMoreUrl, "_blank");
    });

    document.getElementById("btnShareLine")?.addEventListener("click", async () => {
      if (!__lastShareText) return alert("è«‹å…ˆæŒ‰ã€ŒğŸ“ æ¨è–¦é™„è¿‘é¤å»³ã€");
      if (navigator.share) {
        try { await navigator.share({ title:"é™„è¿‘é¤å»³æ¨è–¦", text: __lastShareText, url: __lastMoreUrl }); return; } catch(e) {}
      }
      try { await navigator.clipboard.writeText(__lastShareText); alert("å·²è¤‡è£½ï¼Œè²¼åˆ° LINE å³å¯"); }
      catch(e){ alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"); }
    });

    // ---------- register service worker ----------
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
      });
    }
  </script>
</body>
</html>
